name: Java CI with Maven and Security

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

# –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ä–µ—Ç–∞–º –¥–ª—è workflow
permissions:
  contents: read
  security-events: write

jobs:
  # ==================== SECRETS DETECTION ====================
  secrets-detection:
    runs-on: ubuntu-latest
    container: python:3.11-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

      - name: Install dependencies
        run: |
          pip install trufflehog jq
          apt-get update && apt-get install -y git

      - name: Run TruffleHog Secrets Detection
        id: trufflehog
        run: |
          echo "üîç Starting secrets detection with TruffleHog..."
          
          # –î–ª—è PR —Å–∫–∞–Ω–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –≤–µ—Ç–∫–∞–º–∏, –¥–ª—è push - –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Scanning PR changes from ${{ github.base_ref }} to ${{ github.head_ref }}"
            BASE_REF="${{ github.base_ref }}"
          else
            echo "Scanning commit in push event"
            BASE_REF="HEAD~1"
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º TruffleHog
          trufflehog git \
            --since-commit "$BASE_REF" \
            --max-depth 10000 \
            --regex \
            --entropy=False \
            --json \
            file://$PWD > trufflehog-report.json 2>/dev/null || true
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          if [ -s "trufflehog-report.json" ]; then
            SECRETS_COUNT=$(jq length trufflehog-report.json 2>/dev/null || echo "0")
          
            if [ "$SECRETS_COUNT" -gt "0" ]; then
              echo "‚ùå‚ùå‚ùå CRITICAL: Found $SECRETS_COUNT secrets in the code!"
              echo ""
              echo "=== SECRETS DETECTED ==="
          
              # –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥
              jq -r '.[] | "‚Ä¢ Type: \(.reason)\n  File: \(.path)\n  Line: \(.line)\n  Secret: \(.stringsFound[0])\n"' trufflehog-report.json
          
              echo ""
              echo "##[error] Pipeline failed due to detected secrets"
              echo "##[error] Please remove these secrets before proceeding"
          
              # –î–ª—è PR –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              if [ "${{ github.event_name }}" = "pull_request" ]; then
                SECRETS_LIST=$(jq -r '.[] | "**Type:** \(.reason)  \n**File:** \(.path):\(.line)  \n**Secret:** \(.stringsFound[0] | .[0:50])...  \n---"' trufflehog-report.json)
          
                echo "SECRETS_FOUND=true" >> $GITHUB_OUTPUT
          
                # –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –≤ PR
                gh pr comment ${{ github.event.pull_request.number }} \
                  --body "‚ùå **Secrets detected in code!**  

The following secrets were found:

  $SECRETS_LIST

Please remove all secrets before merging this PR." || echo "Note: Unable to post comment to PR"
                                                                    fi
                                                                    
                                                                    exit 1
                                                                    else
                                                                    echo "‚úÖ No secrets found"
                                                                    fi
                                                                    else
                                                                    echo "‚úÖ No secrets found"
                                                                    fi
                                                                    
                                                                    - name: Upload secrets report
                                                                    if: always()
                                                                    uses: actions/upload-artifact@v4
                                                                    with:
                                                                      name: trufflehog-report
                                                                      path: trufflehog-report.json
                                                                      retention-days: 7

  # ==================== BUILD ====================
                                                                    build:
                                                                      runs-on: ubuntu-latest
                                                                      container: maven:3.9-eclipse-temurin-21
                                                                      needs: [secrets-detection]  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤

                                                                      steps:
                                                                        - name: Checkout code
                                                                          uses: actions/checkout@v4

                                                                        - name: Build with Maven
                                                                          run: mvn clean package -DskipTests

                                                                        - name: Upload build artifact
                                                                          uses: actions/upload-artifact@v4
                                                                          with:
                                                                            name: course-management-jar
                                                                            path: target/*.jar
                                                                            retention-days: 5

  # ==================== SAST ====================
                                                                    sast:
                                                                      needs: build
                                                                      runs-on: ubuntu-latest

                                                                      steps:
                                                                        - name: Checkout code
                                                                          uses: actions/checkout@v4

                                                                        - name: Set up Python
                                                                          uses: actions/setup-python@v4
                                                                          with:
                                                                            python-version: '3.x'

                                                                        - name: Install Semgrep
                                                                          run: pip install semgrep

                                                                        - name: Semgrep Security Scan
                                                                          run: semgrep --config p/default --sarif --output=semgrep.sarif

                                                                        - name: Upload SARIF file
                                                                          uses: github/codeql-action/upload-sarif@v4
                                                                          with:
                                                                            sarif_file: semgrep.sarif
                                                                          if: always()